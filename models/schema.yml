# Schema.yml

version: 2

sources:
  - name: raw
    schema: gz_raw_data
    description: dataset bigquery
    loader: BigQuery 
    tables:
    - name: sales
      identifier: raw_gz_sales
      description: sales of Greenweez / we have one row per product_id found in each orders_id
      tests:
        - unique: 
            column_name: "(orders_id || '-' || pdt_id)"
        - freshness:
            loaded_at_field: "CAST(date_date AS TIMESTAMP)"
            warn_after: {count: 90, period: day}
      columns:
        - name: date_date
          description: date of order
        - name: orders_id
          description: identifier of the order
        - name: pdt_id
          description: identifier of the product
        - name: revenue
          description: revenue generated by selling the products
        - name: quantity
          description: quantity of products ordered
    - name: product
      identifier: raw_gz_product
      description: list of products offered by Greenweez / we have one row per products_id with its purchase price
      columns:
        - name: products_id
          description: identifier of the product
          tests:
            - unique
            - not_null
        - name: purchase_price
          description: price at which the product is offered for sale
    - name: ship
      identifier: raw_gz_ship
      description: shipping fee and costs related to orders / we have one row per orders_id
      columns:
        - name: orders_id
          description: identifier of orders
          tests:
            - unique
            - not_null
        - name: shipping_fee
          description: fee paid by customers for the transportation (frais de livraison)
        - name: logcost
          description: transportation costs
        - name: ship_cost
          description: costs of shipping

models:
  - name: int_sales_margin
    description: revenue, quantity, purchase_price, purchase_cost, margin
    tests:
      - unique:
          column_name: "(products_id || '-' || orders_id)"
    columns:
      - name: products_id
        description: identifier of the products
        tests:
          - not_null
      - name: margin
        description: margin = revenue-purchase_cost (purchase_cost = purchase_price * quantity)
        tests:
          - not_null
  - name: int_orders_margin
    description: margin and other KPIs grouped by orders_id (products_id not available annymore)
    columns:
      - name: orders_id
        description: identifier of the orders
        tests:
          - unique
          - not_null
      - name: margin
        description: margin being revenue less purchase_cost
        tests:
          - not_null
  - name: int_order_operational
    description: operational margin (margin + shipping_fee paid by customers - shipping_cost - log_cost)
    columns:
      - name: orders_id
        description: identifier of orders
        tests:
          - unique
          - not_null
      - name: operational_margin
        description: margin + shipping fee - logistic and shipping costs
        tests:
          - not_null
          